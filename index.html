<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ïã§ÌóòÏö© - ÏôÑÏ†Ñ Í¥ÄÎ¶¨ Î≤ÑÏ†Ñ (Firestore)</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
  :root {
    --bg-light: #f8f9fa;
    --bg-dark: #1a1a1a;
    --text-light: #000;
    --text-dark: #fff;
    --card-light: #ffffff;
    --card-dark: #2d2d2d;
    --border-light: #e0e0e0;
    --border-dark: #444;
    --primary: #27ae60;
    --secondary: #6c757d;
  }
  body {
    font-family: 'Inter', sans-serif;
    margin: 0;
    padding: 20px;
    background: var(--bg-light);
    color: var(--text-light);
    transition: background 0.3s, color 0.3s;
  }
  body.dark {
    background: var(--bg-dark);
    color: var(--text-dark);
  }
  h1 { color: #2c3e50; margin: 0; }
  body.dark h1 { color: #f1c40f; }
  .top-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 10px;
    padding: 10px;
    border: 2px solid var(--border-light);
    border-radius: 8px;
  }
  body.dark .top-controls { border-color: var(--border-dark); }
  .top-buttons {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  .filters {
    background: var(--bg-light);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
    max-width: 1100px;
    margin-left: auto;
    margin-right: auto;
    box-sizing: border-box;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  body.dark .filters { background: #2d2d2d; }
  .filter-group { display: flex; flex-direction: column; gap: 5px; }
  .filter-group label { font-weight: bold; font-size: 14px; }
  select, .filter-buttons {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    background: white;
  }
  body.dark select { background: #333; color: var(--text-dark); border-color: #555; }
  .filter-buttons { display: flex; gap: 5px; flex-wrap: wrap; }
  .filter-btn {
    padding: 5px 12px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    white-space: nowrap;
    transition: all 0.2s;
  }
  .filter-btn.active { background: #007bff; color: white; border-color: #007bff; }
  body.dark .filter-btn { background: #444; color: var(--text-dark); border-color: #666; }
  body.dark .filter-btn.active { background: #0056b3; border-color: #0056b3; }
  .categories-container {
    max-width: 1100px;
    margin: 20px auto;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 20px;
    box-sizing: border-box;
  }
  .category-section { margin: 0; border: 1px solid var(--border-light); border-radius: 10px; overflow: hidden; }
  body.dark .category-section { border-color: var(--border-dark); }
  .category-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 20px;
    font-size: 20px;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .category-content { padding: 20px; background: var(--bg-light); }
  body.dark .category-content { background: var(--bg-dark); }
  .link-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    background: var(--card-light);
    position: relative;
    transition: all 0.2s;
  }
  .link-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
  body.dark .link-card { background: var(--card-dark); border-color: #555; }
  body.dark .link-card:hover { box-shadow: 0 4px 12px rgba(255,255,255,0.1); }
  .link-card a { text-decoration: none; color: #2980b9; font-weight: bold; font-size: 18px; }
  body.dark .link-card a { color: #4aa3ff; }
  .link-meta { display: flex; gap: 10px; margin: 8px 0; font-size: 12px; color: #666; flex-wrap: wrap; }
  body.dark .link-meta { color: #aaa; }
  .tag { background: #e9ecef; padding: 3px 8px; border-radius: 12px; font-size: 11px; white-space: nowrap; }
  body.dark .tag { background: #495057; color: var(--text-dark); }
  .age-tag { background: #d4edda; color: #155724; }
  .category-tag { background: #fff3cd; color: #856404; }
  body.dark .age-tag { background: #28a745; color: white; }
  body.dark .category-tag { background: #ffc107; color: #212529; }
  .card-buttons { position: absolute; top: 8px; right: 8px; display: flex; gap: 5px; }
  .card-btn {
    border: none; border-radius: 50%; width: 25px; height: 25px;
    cursor: pointer; font-size: 12px; color: white;
    display: flex; align-items: center; justify-content: center;
  }
  .edit-btn { background: #3498db; }
  .delete-btn { background: #e74c3c; }
  button {
    padding: 8px 16px; margin: 5px; border: none; border-radius: 6px;
    cursor: pointer; font-weight: bold; transition: all 0.2s;
  }
  button:hover { transform: translateY(-1px); }
  .admin-btn { background: #6c757d; color: white; }
  .admin-btn.active { background: #28a745; }
  .dark-toggle { background: #333; color: var(--text-dark); }
  .add-btn { background: var(--primary); color: white; font-size: 16px; }
  #popup-container { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
  .popup {
    padding: 15px 20px; border-radius: 8px; color: white; font-weight: bold;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    opacity: 0.95; transform: translateX(120%);
    transition: transform 0.4s ease-in-out;
  }
  .popup.show { transform: translateX(0); }
  .popup.success { background: #2ecc71; }
  .popup.error { background: #e74c3c; }
  .no-results {
    text-align: center; color: #666; font-style: italic;
    padding: 40px; background: var(--bg-light); border-radius: 8px; margin: 20px 0;
  }
  body.dark .no-results { color: #aaa; background: var(--bg-dark); }
  .stats {
    display: flex; justify-content: space-between; margin: 10px 0;
    font-size: 12px; color: #666;
    max-width: 1100px; margin-left: auto; margin-right: auto;
    box-sizing: border-box;
  }
  body.dark .stats { color: #aaa; }
  .more-btn-container { text-align: center; margin-top: 20px; }
  .more-btn { background: #f1f3f5; color: #495057; border: 1px solid #dee2e6; }
  body.dark .more-btn { background: #343a40; color: #f8f9fa; border-color: #495057; }
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); display: none;
    justify-content: center; align-items: center; z-index: 999;
  }
  .modal-content {
    background: var(--card-light); padding: 30px; border-radius: 12px;
    width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;
    position: relative;
    box-shadow: 0 8px 30px rgba(0,0,0,0.3);
  }
  body.dark .modal-content { background: var(--card-dark); }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .modal-header h3 { margin: 0; color: #2c3e50; }
  body.dark .modal-header h3 { color: #f1c40f; }
  .close-btn { background: #e74c3c; color: white; border-radius: 50%; width: 30px; height: 30px; border: none; cursor: pointer; }
  .form-group { margin-bottom: 15px; }
  .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
  .form-group input, .form-group textarea, .form-group select {
    width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;
    box-sizing: border-box; font-family: inherit;
  }
  body.dark .form-group input, body.dark .form-group textarea, body.dark .form-group select {
    background: #333; color: var(--text-dark); border-color: #555;
  }
  .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px; }
  .checkbox-item { display: flex; align-items: center; gap: 5px; }
  .checkbox-item input { width: auto; margin: 0; }
  .save-btn { background: var(--primary); color: white; padding: 12px 24px; }
  .cancel-btn { background: var(--secondary); color: white; padding: 12px 24px; }
  .data-management {
    max-width: 1100px; margin: 20px auto; padding: 20px;
    background: var(--bg-light); border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  body.dark .data-management { background: var(--card-dark); }
  .data-controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
  .export-btn { background: #17a2b8; color: white; }
  .import-btn { background: #fd7e14; color: white; }
  .reset-btn { background: #dc3545; color: white; }
  #importFile { display: none; }
  .user-id-display {
    text-align: center;
    font-size: 14px;
    color: #888;
    margin-top: 20px;
    word-break: break-all;
  }
  body.dark .user-id-display { color: #aaa; }
</style>
</head>
<body>

<div class="top-controls">
  <h1>üìö Ïã§ÌóòÏ§ëÏù∏ ÏÇ¨Ïù¥Ìä∏ - ÏôÑÏ†Ñ Í¥ÄÎ¶¨ Î≤ÑÏ†Ñ</h1>
  <div class="top-buttons">
    <button id="adminToggle" class="admin-btn">üîí Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏Ïù∏</button>
    <button id="addSiteBtn" class="add-btn" style="display:none;">‚ûï ÏÉà ÏÇ¨Ïù¥Ìä∏ Ï∂îÍ∞Ä</button>
    <button class="dark-toggle" onclick="window.toggleDarkMode()">üåô Îã§ÌÅ¨ Î™®Îìú</button>
  </div>
</div>

<div id="popup-container"></div>
<div id="confirmation-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="confirmTitle">ÌôïÏù∏</h3>
      <button class="close-btn" onclick="window.closeConfirmationModal()">‚úï</button>
    </div>
    <p id="confirmMessage"></p>
    <div style="text-align: right; margin-top: 20px;">
      <button class="cancel-btn" onclick="window.closeConfirmationModal()">Ï∑®ÏÜå</button>
      <button class="save-btn" id="confirmActionBtn">ÌôïÏù∏</button>
    </div>
  </div>
</div>

<div class="filters">
  <div class="filter-group"><label>Ïó∞Î†πÎåÄ:</label><div class="filter-buttons" id="ageFilter">
    <button class="filter-btn active" data-age="all">Ï†ÑÏ≤¥</button>
    <button class="filter-btn" data-age="elem">Ï¥àÎì±</button>
    <button class="filter-btn" data-age="mid">Ï§ëÎì±</button>
    <button class="filter-btn" data-age="high">Í≥†Îì±</button>
    <button class="filter-btn" data-age="adult">ÏÑ±Ïù∏</button>
  </div></div>
  <div class="filter-group"><label>Ïπ¥ÌÖåÍ≥†Î¶¨:</label><div class="filter-buttons" id="categoryFilter">
    <button class="filter-btn active" data-category="all">Ï†ÑÏ≤¥</button>
    <button class="filter-btn" data-category="learning">ÌïôÏäµ</button>
    <button class="filter-btn" data-category="info">Ï†ïÎ≥¥</button>
    <button class="filter-btn" data-category="news">Îâ¥Ïä§</button>
    <button class="filter-btn" data-category="search">Í≤ÄÏÉâÏóîÏßÑ</button>
    <button class="filter-btn" data-category="gpt">GPT</button>
  </div></div>
  <div class="filter-group"><label>Í≥ºÎ™©:</label>
    <select id="subjectFilter">
      <option value="all">Ï†ÑÏ≤¥ Í≥ºÎ™©</option>
      <option value="korean">Íµ≠Ïñ¥</option>
      <option value="math">ÏàòÌïô</option>
      <option value="english">ÏòÅÏñ¥</option>
      <option value="science">Í≥ºÌïô</option>
      <option value="social">ÏÇ¨Ìöå</option>
      <option value="history">Ïó≠ÏÇ¨</option>
      <option value="art">ÏòàÏà†</option>
      <option value="music">ÏùåÏïÖ</option>
      <option value="pe">Ï≤¥Ïú°</option>
      <option value="tech">Í∏∞Ïà†</option>
      <option value="coding">ÏΩîÎî©</option>
      <option value="language">Ïô∏Íµ≠Ïñ¥</option>
      <option value="general">Ï¢ÖÌï©</option>
      <option value="exam">ÏãúÌóòÎåÄÎπÑ</option>
      <option value="career">ÏßÑÎ°ú</option>
    </select>
  </div>
  <div class="filter-group"><button onclick="window.resetFilters()" style="background:#6c757d;color:white;border:none;padding:8px 12px;border-radius:4px;">ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî</button></div>
</div>

<div class="stats">
  <span>Ï¥ù <span id="totalCount">0</span>Í∞ú ÏÇ¨Ïù¥Ìä∏</span>
  <span>ÌïÑÌÑ∞ÎßÅÎêú Í≤∞Í≥º: <span id="filteredCount">0</span>Í∞ú</span>
</div>

<div class="categories-container">
  <div class="category-section" id="learning-section">
    <div class="category-header">üìñ ÌïôÏäµ ÏÇ¨Ïù¥Ìä∏</div>
    <div class="category-content" id="learning-content"></div>
  </div>
  <div class="category-section" id="info-section">
    <div class="category-header">üìã Ï†ïÎ≥¥ ÏÇ¨Ïù¥Ìä∏</div>
    <div class="category-content" id="info-content"></div>
  </div>
  <div class="category-section" id="news-section">
    <div class="category-header">üì∞ Îâ¥Ïä§ ÏÇ¨Ïù¥Ìä∏</div>
    <div class="category-content" id="news-content"></div>
  </div>
  <div class="category-section" id="search-section">
    <div class="category-header">üîç Í≤ÄÏÉâ ÏóîÏßÑ</div>
    <div class="category-content" id="search-content"></div>
  </div>
  <div class="category-section" id="gpt-section">
    <div class="category-header">ü§ñ GPT ÏÇ¨Ïù¥Ìä∏</div>
    <div class="category-content" id="gpt-content"></div>
  </div>
</div>

<div id="noResults" class="no-results" style="display:none;">Ï°∞Í±¥Ïóê ÎßûÎäî ÏÇ¨Ïù¥Ìä∏Í∞Ä ÏóÜÏäµÎãàÎã§.</div>

<div id="dataManagement" class="data-management" style="display:none;">
  <h3>üìä Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨</h3>
  <div class="data-controls">
    <button class="export-btn" onclick="window.exportData()">üì• Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (JSON)</button>
    <button class="import-btn" onclick="document.getElementById('importFile').click()">üì§ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞</button>
    <input type="file" id="importFile" accept=".json" onchange="window.importData(event)">
    <button class="reset-btn" onclick="window.openResetModal()">üóëÔ∏è Î™®Îì† Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî</button>
  </div>
</div>

<p class="user-id-display">ÏÇ¨Ïö©Ïûê ID: <span id="userIdDisplay"></span></p>

<div class="modal-overlay" id="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">ÏÉà ÏÇ¨Ïù¥Ìä∏ Ï∂îÍ∞Ä</h3>
      <button class="close-btn" onclick="window.closeModal()">‚úï</button>
    </div>
    <form id="siteForm" onsubmit="window.saveSite(event)">
      <div class="form-group">
        <label for="siteName">ÏÇ¨Ïù¥Ìä∏ Ïù¥Î¶Ñ *</label>
        <input type="text" id="siteName" required>
      </div>
      <div class="form-group">
        <label for="siteUrl">URL *</label>
        <input type="url" id="siteUrl" required placeholder="https://example.com">
      </div>
      <div class="form-group">
        <label for="siteDesc">ÏÑ§Î™Ö</label>
        <textarea id="siteDesc" rows="3" placeholder="ÏÇ¨Ïù¥Ìä∏Ïóê ÎåÄÌïú Í∞ÑÎã®Ìïú ÏÑ§Î™Ö"></textarea>
      </div>
      <div class="form-group">
        <label for="siteCategory">Ïπ¥ÌÖåÍ≥†Î¶¨ *</label>
        <select id="siteCategory" required>
          <option value="">Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù</option>
          <option value="learning">ÌïôÏäµ</option>
          <option value="info">Ï†ïÎ≥¥</option>
          <option value="news">Îâ¥Ïä§</option>
          <option value="search">Í≤ÄÏÉâÏóîÏßÑ</option>
          <option value="gpt">GPT</option>
        </select>
      </div>
      <div class="form-group">
        <label>Ïó∞Î†πÎåÄ * (Î≥µÏàò ÏÑ†ÌÉù Í∞ÄÎä•)</label>
        <div class="checkbox-group" id="ageCheckboxes">
          <div class="checkbox-item"><input type="checkbox" id="age-elem" value="elem"><label for="age-elem">Ï¥àÎì±ÌïôÏÉù</label></div>
          <div class="checkbox-item"><input type="checkbox" id="age-mid" value="mid"><label for="age-mid">Ï§ëÌïôÏÉù</label></div>
          <div class="checkbox-item"><input type="checkbox" id="age-high" value="high"><label for="age-high">Í≥†Îì±ÌïôÏÉù</label></div>
          <div class="checkbox-item"><input type="checkbox" id="age-adult" value="adult"><label for="age-adult">ÏÑ±Ïù∏</label></div>
        </div>
      </div>
      <div class="form-group">
        <label>Í≥ºÎ™© (Î≥µÏàò ÏÑ†ÌÉù Í∞ÄÎä•)</label>
        <div class="checkbox-group" id="subjectCheckboxes">
          <div class="checkbox-item"><input type="checkbox" id="subj-korean" value="korean"><label for="subj-korean">Íµ≠Ïñ¥</label></div>
          <div class="checkbox-item"><input type="checkbox" id="subj-math" value="math"><label for="subj-math">ÏàòÌïô</label></div>
          <div class="checkbox-item"><input type="checkbox" id="subj-english" value="english"><label for="subj-english">ÏòÅÏñ¥</label></div>
          <div class="checkbox-item"><input type="checkbox" id="subj-science" value="science"><label for="subj-science">Í≥ºÌïô</label></div>
          <div class="checkbox-item"><input type="checkbox" id="subj-social" value="social"><label for="subj-social">ÏÇ¨Ìöå</label></div>
          <div class="checkbox-item"><input type="checkbox" id="subj-history" value="history"><label for="subj-history">Ïó≠ÏÇ¨</label></div>
          <div class="checkbox-item"><input type="checkbox" id="subj-art" value="art"><label for="subj-art">ÏòàÏà†</label></div>
          <div class="checkbox-item"><input type="checkbox" id="subj-music" value="music"><label for="subj-music">ÏùåÏïÖ</label></div>
          <div class="checkbox-item"><input type="checkbox" id="subj-pe" value="pe"><label for="subj-pe">Ï≤¥Ïú°</label></div>
          <div class="checkbox-item"><input type="checkbox" id="subj-tech" value="tech"><label for="subj-tech">Í∏∞Ïà†</label></div>
          <div class="checkbox-item"><input type="checkbox" id="subj-coding" value="coding"><label for="subj-coding">ÏΩîÎî©</label></div>
          <div class="checkbox-item"><input type="checkbox" id="subj-language" value="language"><label for="subj-language">Ïô∏Íµ≠Ïñ¥</label></div>
          <div class="checkbox-item"><input type="checkbox" id="subj-general" value="general"><label for="subj-general">Ï¢ÖÌï©</label></div>
          <div class="checkbox-item"><input type="checkbox" id="subj-exam" value="exam"><label for="subj-exam">ÏãúÌóòÎåÄÎπÑ</label></div>
          <div class="checkbox-item"><input type="checkbox" id="subj-career" value="career"><label for="subj-career">ÏßÑÎ°ú</label></div>
        </div>
      </div>
      <div style="text-align: right; margin-top: 20px;">
        <button type="button" class="cancel-btn" onclick="window.closeModal()">Ï∑®ÏÜå</button>
        <button type="submit" class="save-btn">Ï†ÄÏû•</button>
      </div>
    </form>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, setLogLevel, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const ageNames = {elem:"Ï¥àÎì±ÌïôÏÉù", mid:"Ï§ëÌïôÏÉù", high:"Í≥†Îì±ÌïôÏÉù", adult:"ÏÑ±Ïù∏"};
const categoryNames = {learning:"ÌïôÏäµ", info:"Ï†ïÎ≥¥", news:"Îâ¥Ïä§", search:"Í≤ÄÏÉâÏóîÏßÑ", gpt:"GPT ÏÇ¨Ïù¥Ìä∏"};
const subjectNames = {korean:"Íµ≠Ïñ¥", math:"ÏàòÌïô", english:"ÏòÅÏñ¥", science:"Í≥ºÌïô", social:"ÏÇ¨Ìöå", history:"Ïó≠ÏÇ¨", art:"ÏòàÏà†", music:"ÏùåÏïÖ", pe:"Ï≤¥Ïú°", tech:"Í∏∞Ïà†", coding:"ÏΩîÎî©", language:"Ïô∏Íµ≠Ïñ¥", general:"Ï¢ÖÌï©", exam:"ÏãúÌóòÎåÄÎπÑ", career:"ÏßÑÎ°ú"};

const DEFAULT_SITES = [
  {name:"EBS Ï¥àÎì±", url:"https://www.ebs.co.kr/course/home?courseType=ELMT", desc:"Ï¥àÎì± Ï†Ñ Í≥ºÎ™© Ïò®ÎùºÏù∏ Í∞ïÏùò", category:"learning", ages:["elem"], subjects:["korean","math","science","social"]},
  {name:"Khan Academy", url:"https://ko.khanacademy.org/", desc:"ÏàòÌïô, Í≥ºÌïô Î¨¥Î£å Í∞ïÏùò", category:"learning", ages:["elem","mid","high","adult"], subjects:["math","science"]},
  {name:"Duolingo", url:"https://www.duolingo.com/", desc:"Ïô∏Íµ≠Ïñ¥ ÌïôÏäµ Í≤åÏûÑÌòï ÌîåÎû´Ìèº", category:"learning", ages:["elem","mid","high","adult"], subjects:["language","english"]},
  {name:"ÏΩîÎî©Ïùò Ï†ïÏÑù", url:"https://www.codingjs.com/", desc:"Ï¥àÎ≥¥ÏûêÎ•º ÏúÑÌïú ÏΩîÎî© Í∏∞Î≥∏Í∏∞ Í∞ïÏùò", category:"learning", ages:["mid","high"], subjects:["coding", "tech"]},
  {name:"ÏúÑÌÇ§Î∞±Í≥º", url:"https://ko.wikipedia.org/", desc:"ÏûêÏú† Î∞±Í≥ºÏÇ¨Ï†Ñ", category:"info", ages:["mid","high","adult"], subjects:["general"]},
  {name:"Íµ≠Î¶ΩÏ§ëÏïôÍ≥ºÌïôÍ¥Ä", url:"https://www.science.go.kr/", desc:"Í≥ºÌïô Ï≤¥Ìóò Î∞è ÍµêÏú° Ï†ïÎ≥¥", category:"info", ages:["elem","mid","high"], subjects:["science"]},
  {name:"ÎÑ§Ïù¥Î≤Ñ ÏßÄÏãùÎ∞±Í≥º", url:"https://terms.naver.com/", desc:"Îã§ÏñëÌïú Î∂ÑÏïºÏùò ÏßÄÏãùÎ∞±Í≥º", category:"info", ages:["elem","mid","high","adult"], subjects:["general"]},
  {name:"Ïó∞Ìï©Îâ¥Ïä§", url:"https://www.yna.co.kr/", desc:"ÎåÄÌïúÎØºÍµ≠ ÎåÄÌëú Îâ¥Ïä§ÌÜµÏã†ÏÇ¨", category:"news", ages:["mid","high","adult"], subjects:["social","general"]},
  {name:"BBC News ÏΩîÎ¶¨ÏïÑ", url:"https://www.bbc.com/korean", desc:"BBC ÌïúÍµ≠Ïñ¥ Îâ¥Ïä§", category:"news", ages:["high","adult"], subjects:["english","social"]},
  {name:"ÎÑ§Ïù¥Î≤Ñ", url:"https://www.naver.com/", desc:"ÎåÄÌïúÎØºÍµ≠ ÎåÄÌëú Ìè¨ÌÑ∏ÏÇ¨Ïù¥Ìä∏", category:"search", ages:["elem","mid","high","adult"], subjects:["general"]},
  {name:"Íµ¨Í∏Ä", url:"https://www.google.com/", desc:"ÏÑ∏Í≥Ñ ÏµúÎåÄ Í≤ÄÏÉâÏóîÏßÑ", category:"search", ages:["elem","mid","high","adult"], subjects:["general"]},
  {name:"ChatGPT", url:"https://chat.openai.com/", desc:"OpenAIÏùò ÎåÄÌôîÌòï AI Ï±óÎ¥á", category:"gpt", ages:["mid","high","adult"], subjects:["general"]},
  {name:"Gemini", url:"https://gemini.google.com/", desc:"GoogleÏùò ÎåÄÌôîÌòï AI Î™®Îç∏", category:"gpt", ages:["mid","high","adult"], subjects:["general"]},
  {name:"Perplexity AI", url:"https://www.perplexity.ai/", desc:"ÏßàÎ¨∏ ÎãµÎ≥ÄÏóê ÌäπÌôîÎêú AI Í≤ÄÏÉâ ÏóîÏßÑ", category:"gpt", ages:["high","adult"], subjects:["general","search"]},
  {name:"Claude AI", url:"https://claude.ai/", desc:"AnthropicÏùò ÎåÄÌôîÌòï AI Î™®Îç∏", category:"gpt", ages:["high","adult"], subjects:["general"]}
];

let currentAgeFilter = "all";
let currentCategoryFilter = "all";
let currentSubjectFilter = "all";
let isAdminLoggedIn = false;
let sites = [];
let db, auth, userId;
let currentUnsubscribe = null;

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

const app = initializeApp(firebaseConfig);
auth = getAuth(app);
db = getFirestore(app);
setLogLevel('debug');

onAuthStateChanged(auth, async (user) => {
  if (user) {
    userId = user.uid;
    document.getElementById('userIdDisplay').textContent = userId;
    await fetchSitesFromFirestore();
  } else {
    if (typeof __initial_auth_token !== 'undefined') {
      await signInWithCustomToken(auth, __initial_auth_token);
    } else {
      await signInAnonymously(auth);
    }
  }
});

async function fetchSitesFromFirestore() {
  const collectionPath = `/artifacts/${appId}/users/${userId}/sites`;
  const sitesCollectionRef = collection(db, collectionPath);
  
  if (currentUnsubscribe) {
    currentUnsubscribe();
  }
  
  currentUnsubscribe = onSnapshot(sitesCollectionRef, (querySnapshot) => {
    const fetchedSites = [];
    querySnapshot.forEach((doc) => {
      const siteData = doc.data();
      fetchedSites.push({ ...siteData, id: doc.id });
    });
    sites = fetchedSites;
    if (sites.length === 0) {
      addInitialData();
    }
    renderSites();
  }, (error) => {
    console.error("Firestore Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë Ïò§Î•ò Î∞úÏÉù:", error);
    window.showPopup("Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.", true);
  });
}

async function addInitialData() {
  if (sites.length === 0) {
    const batch = writeBatch(db);
    const sitesCollectionRef = collection(db, `/artifacts/${appId}/users/${userId}/sites`);
    DEFAULT_SITES.forEach(site => {
      const newDocRef = doc(sitesCollectionRef);
      batch.set(newDocRef, site);
    });
    await batch.commit();
    console.log("Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.");
  }
}

window.showPopup = function(message, isError = false) {
  const container = document.getElementById("popup-container");
  const popup = document.createElement("div");
  popup.className = `popup ${isError ? 'error' : 'success'}`;
  popup.textContent = message;
  container.appendChild(popup);
  setTimeout(() => popup.classList.add("show"), 10);
  setTimeout(() => {
    popup.classList.remove("show");
    popup.addEventListener('transitionend', () => popup.remove());
  }, 3000);
}

let confirmCallback = null;
window.openConfirmationModal = function(title, message, onConfirm) {
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmMessage').textContent = message;
  confirmCallback = onConfirm;
  document.getElementById('confirmation-modal').style.display = 'flex';
}
window.closeConfirmationModal = function() {
  document.getElementById('confirmation-modal').style.display = 'none';
  confirmCallback = null;
}
document.getElementById('confirmActionBtn').addEventListener('click', () => {
  if (confirmCallback) {
    confirmCallback();
  }
  window.closeConfirmationModal();
});

window.toggleAdmin = function() {
  if (isAdminLoggedIn) {
    window.logout();
  } else {
    checkAdminAuth();
  }
}

function checkAdminAuth() {
  const password = window.prompt("Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:");
  if (password === "admin123") {
    isAdminLoggedIn = true;
    window.showPopup("Í¥ÄÎ¶¨Ïûê Î™®ÎìúÍ∞Ä ÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§!");
    updateAdminUI();
  } else if (password !== null) {
    window.showPopup("ÏûòÎ™ªÎêú ÎπÑÎ∞ÄÎ≤àÌò∏ÏûÖÎãàÎã§.", true);
  }
}

window.logout = function() {
  isAdminLoggedIn = false;
  window.showPopup("Í¥ÄÎ¶¨Ïûê Î™®ÎìúÍ∞Ä ÎπÑÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§.");
  updateAdminUI();
}

function updateAdminUI() {
  const adminToggle = document.getElementById('adminToggle');
  const addBtn = document.getElementById('addSiteBtn');
  const dataManagement = document.getElementById('dataManagement');
  
  if (adminToggle) {
    adminToggle.textContent = isAdminLoggedIn ? 'üîì Í¥ÄÎ¶¨Ïûê Î™®Îìú (Î°úÍ∑∏ÏïÑÏõÉ)' : 'üîí Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏Ïù∏';
    adminToggle.className = isAdminLoggedIn ? 'admin-btn active' : 'admin-btn';
  }
  if (addBtn) addBtn.style.display = isAdminLoggedIn ? 'inline-block' : 'none';
  if (dataManagement) dataManagement.style.display = isAdminLoggedIn ? 'block' : 'none';
  
  renderSites();
}

function updateStats() {
  document.getElementById("totalCount").textContent = sites.length;
  document.getElementById("filteredCount").textContent = getFilteredSites().length;
}

function getFilteredSites() {
  return sites.filter(s =>
    (currentAgeFilter === "all" || (s.ages && s.ages.includes(currentAgeFilter))) &&
    (currentCategoryFilter === "all" || s.category === currentCategoryFilter) &&
    (currentSubjectFilter === "all" || (s.subjects && s.subjects.includes(currentSubjectFilter)))
  );
}

function createSiteCard(site, index) {
  const card = document.createElement("div");
  card.className = "link-card";
  
  const ageTags = (site.ages || []).map(a => `<span class="tag age-tag">${ageNames[a] || a}</span>`).join(" ");
  const categoryTag = `<span class="tag category-tag">${categoryNames[site.category] || site.category}</span>`;
  
  const adminButtons = isAdminLoggedIn ? `
    <div class="card-buttons">
      <button class="card-btn edit-btn" onclick="window.openEditModal('${site.id}')" title="ÏàòÏ†ï">‚úèÔ∏è</button>
      <button class="card-btn delete-btn" onclick="window.openDeleteModal('${site.id}', '${site.name}')" title="ÏÇ≠Ï†ú">üóëÔ∏è</button>
    </div>
  ` : '';
  
  card.innerHTML = `
    ${adminButtons}
    <a href="${site.url}" target="_blank">${site.name}</a>
    <div class="link-meta">${categoryTag} ${ageTags}</div>
    <p>${site.desc || 'ÏÑ§Î™ÖÏù¥ ÏóÜÏäµÎãàÎã§.'}</p>
  `;
  return card;
}

function renderSites() {
  const categories = Object.keys(categoryNames);
  const allFilteredSites = getFilteredSites();
  let hasResults = allFilteredSites.length > 0;
  
  categories.forEach(category => {
    const container = document.getElementById(`${category}-content`);
    const section = document.getElementById(`${category}-section`);
    const sitesInCategory = allFilteredSites.filter(s => s.category === category);
    
    if (container) {
      container.innerHTML = "";
      if (sitesInCategory.length > 0) {
        if (section) section.style.display = "block";
        sitesInCategory.forEach(site => {
          container.appendChild(createSiteCard(site));
        });
      } else {
        if (section) section.style.display = (currentCategoryFilter === "all" || currentCategoryFilter === category) ? "block" : "none";
        container.innerHTML = "<p style='color:#666;text-align:center;padding:20px;'>Ìï¥Îãπ Ï°∞Í±¥Ïùò ÏÇ¨Ïù¥Ìä∏Í∞Ä ÏóÜÏäµÎãàÎã§.</p>";
      }
    }
  });

  document.getElementById("noResults").style.display = hasResults ? "none" : "block";
  updateStats();
}

function setupFilters() {
  document.querySelectorAll("#ageFilter .filter-btn").forEach(btn =>
    btn.addEventListener("click", e => {
      document.querySelector("#ageFilter .active")?.classList.remove("active");
      e.target.classList.add("active");
      currentAgeFilter = e.target.dataset.age;
      renderSites();
    })
  );

  document.querySelectorAll("#categoryFilter .filter-btn").forEach(btn =>
    btn.addEventListener("click", e => {
      document.querySelector("#categoryFilter .active")?.classList.remove("active");
      e.target.classList.add("active");
      currentCategoryFilter = e.target.dataset.category;
      renderSites();
    })
  );

  document.getElementById("subjectFilter").addEventListener("change", e => {
    currentSubjectFilter = e.target.value;
    renderSites();
  });
}

window.resetFilters = function() {
  currentAgeFilter = "all";
  currentCategoryFilter = "all";
  currentSubjectFilter = "all";
  document.querySelector("#ageFilter .filter-btn[data-age='all']")?.click();
  document.querySelector("#categoryFilter .filter-btn[data-category='all']")?.click();
  document.getElementById("subjectFilter").value = "all";
  renderSites();
}

let editingDocId = null;

window.openAddModal = function() {
  if (!isAdminLoggedIn) {
    checkAdminAuth();
    if (!isAdminLoggedIn) return;
  }
  editingDocId = null;
  document.getElementById("modalTitle").textContent = "ÏÉà ÏÇ¨Ïù¥Ìä∏ Ï∂îÍ∞Ä";
  document.getElementById("siteForm").reset();
  clearFormCheckboxes();
  document.getElementById("modal").style.display = "flex";
}

window.openEditModal = function(docId) {
  if (!isAdminLoggedIn) {
    checkAdminAuth();
    if (!isAdminLoggedIn) return;
  }
  editingDocId = docId;
  const site = sites.find(s => s.id === docId);
  if (!site) {
    window.showPopup("ÏÇ¨Ïù¥Ìä∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.", true);
    return;
  }
  document.getElementById("modalTitle").textContent = "ÏÇ¨Ïù¥Ìä∏ ÏàòÏ†ï";
  
  document.getElementById("siteName").value = site.name;
  document.getElementById("siteUrl").value = site.url;
  document.getElementById("siteDesc").value = site.desc || "";
  document.getElementById("siteCategory").value = site.category;
  
  clearFormCheckboxes();
  (site.ages || []).forEach(age => {
    const checkbox = document.getElementById(`age-${age}`);
    if (checkbox) checkbox.checked = true;
  });
  
  (site.subjects || []).forEach(subject => {
    const checkbox = document.getElementById(`subj-${subject}`);
    if (checkbox) checkbox.checked = true;
  });
  
  document.getElementById("modal").style.display = "flex";
}

window.closeModal = function() {
  document.getElementById("modal").style.display = "none";
  document.getElementById("siteForm").reset();
  clearFormCheckboxes();
}

function clearFormCheckboxes() {
  document.querySelectorAll('#ageCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
  document.querySelectorAll('#subjectCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
}

window.saveSite = async function(event) {
  event.preventDefault();
  
  const name = document.getElementById("siteName").value.trim();
  const url = document.getElementById("siteUrl").value.trim();
  const desc = document.getElementById("siteDesc").value.trim();
  const category = document.getElementById("siteCategory").value;
  
  const ages = Array.from(document.querySelectorAll('#ageCheckboxes input[type="checkbox"]:checked')).map(cb => cb.value);
  const subjects = Array.from(document.querySelectorAll('#subjectCheckboxes input[type="checkbox"]:checked')).map(cb => cb.value);
  
  if (!name || !url || !category || ages.length === 0) {
    window.showPopup("ÌïÑÏàò Ìï≠Î™©ÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.", true);
    return;
  }
  
  const siteData = {
    name: name,
    url: url,
    desc: desc,
    category: category,
    ages: ages,
    subjects: subjects.length > 0 ? subjects : ["general"]
  };
  
  const collectionRef = collection(db, `/artifacts/${appId}/users/${userId}/sites`);

  try {
    if (editingDocId) {
      await updateDoc(doc(collectionRef, editingDocId), siteData);
      window.showPopup("ÏÇ¨Ïù¥Ìä∏Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§!");
    } else {
      await addDoc(collectionRef, siteData);
      window.showPopup("ÏÉà ÏÇ¨Ïù¥Ìä∏Í∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!");
    }
    window.closeModal();
  } catch (e) {
    console.error("Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïã§Ìå®:", e);
    window.showPopup("Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.", true);
  }
}

window.openDeleteModal = function(docId, siteName) {
  if (!isAdminLoggedIn) {
    checkAdminAuth();
    if (!isAdminLoggedIn) return;
  }
  window.openConfirmationModal(
    'ÏÇ¨Ïù¥Ìä∏ ÏÇ≠Ï†ú',
    `'${siteName}' ÏÇ¨Ïù¥Ìä∏Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`,
    () => window.deleteSite(docId)
  );
}

window.deleteSite = async function(docId) {
  try {
    const docRef = doc(db, `/artifacts/${appId}/users/${userId}/sites/${docId}`);
    await deleteDoc(docRef);
    window.showPopup("ÏÇ¨Ïù¥Ìä∏Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§!");
  } catch (e) {
    console.error("Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú Ïã§Ìå®:", e);
    window.showPopup("Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.", true);
  }
}

window.exportData = async function() {
  if (!isAdminLoggedIn) {
    checkAdminAuth();
    if (!isAdminLoggedIn) return;
  }
  try {
    const collectionRef = collection(db, `/artifacts/${appId}/users/${userId}/sites`);
    const querySnapshot = await getDocs(collectionRef);
    const data = [];
    querySnapshot.forEach(doc => {
      data.push(doc.data());
    });
    
    const dataStr = JSON.stringify(data, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `sites_backup_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url);
    window.showPopup("Îç∞Ïù¥ÌÑ∞Í∞Ä ÎÇ¥Î≥¥ÎÇ¥Ï°åÏäµÎãàÎã§!");
  } catch (error) {
    console.error("Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Ïã§Ìå®:", error);
    window.showPopup("Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.", true);
  }
}

window.importData = async function(event) {
  if (!isAdminLoggedIn) {
    checkAdminAuth();
    if (!isAdminLoggedIn) return;
  }
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      const importedData = JSON.parse(e.target.result);
      if (Array.isArray(importedData)) {
        window.openConfirmationModal(
          'Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞',
          "Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Î•º Î™®Îëê ÍµêÏ≤¥ÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.",
          async () => {
            const batch = writeBatch(db);
            const collectionRef = collection(db, `/artifacts/${appId}/users/${userId}/sites`);
            
            const existingDocs = await getDocs(collectionRef);
            existingDocs.forEach(doc => batch.delete(doc.ref));
            
            importedData.forEach(site => {
              const newDocRef = doc(collectionRef);
              batch.set(newDocRef, site);
            });
            
            await batch.commit();
            window.showPopup("Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Í∞ÄÏ†∏ÏôÄÏ°åÏäµÎãàÎã§!");
          }
        );
      } else {
        window.showPopup("Ïò¨Î∞îÎ•∏ JSON ÌòïÏãùÏù¥ ÏïÑÎãôÎãàÎã§.", true);
      }
    } catch (error) {
      console.error("ÌååÏùº ÏùΩÍ∏∞ Ïã§Ìå®:", error);
      window.showPopup("ÌååÏùºÏùÑ ÏùΩÎäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.", true);
    }
  };
  reader.readAsText(file);
  event.target.value = "";
}

window.openResetModal = function() {
  if (!isAdminLoggedIn) {
    checkAdminAuth();
    if (!isAdminLoggedIn) return;
  }
  window.openConfirmationModal(
    'Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî',
    "Ï†ïÎßêÎ°ú Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.",
    window.resetAllData
  );
}

window.resetAllData = async function() {
  try {
    const collectionRef = collection(db, `/artifacts/${appId}/users/${userId}/sites`);
    const existingDocs = await getDocs(collectionRef);
    const batch = writeBatch(db);
    existingDocs.forEach(doc => {
      batch.delete(doc.ref);
    });
    await batch.commit();
    window.showPopup("Îç∞Ïù¥ÌÑ∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§!");
    addInitialData();
  } catch (e) {
    console.error("Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî Ïã§Ìå®:", e);
    window.showPopup("Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞ÌôîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.", true);
  }
}

window.toggleDarkMode = function() {
  document.body.classList.toggle("dark");
  const isDark = document.body.classList.contains("dark");
  window.showPopup(isDark ? "Îã§ÌÅ¨ Î™®ÎìúÍ∞Ä ÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§." : "ÎùºÏù¥Ìä∏ Î™®ÎìúÍ∞Ä ÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§.");
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('adminToggle').addEventListener('click', window.toggleAdmin);
  document.getElementById('addSiteBtn').addEventListener('click', window.openAddModal);
  setupFilters();
  updateAdminUI();
});
</script>
</body>
</html>
